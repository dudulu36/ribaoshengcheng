<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥æŠ¥è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 15px; }
        .header h1 { font-size: 1.5em; margin-bottom: 4px; }
        .header p { font-size: 0.9em; opacity: 0.9; }
        .card { background: white; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); padding: 15px; margin-bottom: 15px; }
        .upload-section { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        @media (max-width: 600px) { .upload-section { grid-template-columns: 1fr; } }
        .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 12px; text-align: center; transition: all 0.3s; cursor: pointer; }
        .upload-box:hover { border-color: #667eea; background: #f8f9ff; }
        .upload-box.has-file { border-color: #28a745; background: #f0fff4; }
        .upload-icon { font-size: 36px; margin-bottom: 8px; }
        .upload-title { font-size: 1em; font-weight: 600; color: #333; margin-bottom: 4px; }
        .upload-desc { font-size: 0.85em; color: #666; }
        .upload-hint { font-size: 0.75em; color: #666; margin-bottom: 4px; text-align: center; }
        .file-name { margin-top: 10px; padding: 6px 12px; background: #667eea; color: white; border-radius: 15px; font-size: 0.8em; display: none; }
        .upload-box.has-file .file-name { display: inline-block; background: #28a745; }
        input[type="file"] { display: none; }
        .btn { display: block; width: 100%; padding: 10px 20px; font-size: 1em; font-weight: 600; color: white; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s; margin-bottom: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-clear { background: #999; }
        .result-section { display: none; }
        .result-section.show { display: block; }
        .result-title { font-size: 1em; font-weight: 600; color: #333; margin-bottom: 8px; }
        .result-content { background: #f8f9fa; border-radius: 8px; padding: 10px; font-family: 'Consolas', monospace; font-size: 0.9em; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; border: 1px solid #e9ecef; max-height: 300px; overflow-y: auto; }
        .copy-btn { margin-top: 10px; padding: 8px 16px; font-size: 0.9em; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .copy-btn:hover { background: #138496; }
        .tips { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-bottom: 10px; font-size: 0.8em; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ—¥æŠ¥è‡ªåŠ¨ç”Ÿæˆç³»ç»Ÿ</h1>
            <p>ä¸Šä¼  Excel æ–‡ä»¶ï¼Œä¸€é”®ç”Ÿæˆæ—¥æŠ¥</p>
        </div>
        <div class="card">
            <div class="tips">ğŸ’¡ æç¤ºï¼šå¯ä»¥åªä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶ç”Ÿæˆå¯¹åº”çš„å†…å®¹</div>
            <div class="upload-section">
                <div class="upload-box" id="spotBox" onclick="document.getElementById('spotFile').click()">
                    <div class="upload-hint">è†é£çœå†…ç°è´§æŠ«éœ²å½“æœˆ1å·è‡³ä»Šçš„æ•°æ®</div>
                    <div class="upload-icon">ğŸ“Š</div>
                    <div class="upload-title">çœå†…ç°è´§å¤ç›˜æ–‡ä»¶</div>
                    <div class="upload-desc">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div>
                    <div class="file-name" id="spotFileName"></div>
                    <input type="file" id="spotFile" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'spot')">
                </div>
                <div class="upload-box" id="midtermBox" onclick="document.getElementById('midtermFile').click()">
                    <div class="upload-hint">è†é£ä¸­é•¿æœŸå¤ç›˜æ»šæ’®å•æ—¥æ•°æ®ï¼ˆå¯ä¸ä¸Šä¼ ï¼‰</div>
                    <div class="upload-icon">ğŸ“ˆ</div>
                    <div class="upload-title">ä¸­é•¿æœŸå¤ç›˜æ–‡ä»¶</div>
                    <div class="upload-desc">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶</div>
                    <div class="file-name" id="midtermFileName"></div>
                    <input type="file" id="midtermFile" accept=".xlsx,.xls" onchange="handleFileSelect(this, 'midterm')">
                </div>
            </div>
            <button class="btn" id="generateBtn" onclick="generateReport()">ç”Ÿæˆæ—¥æŠ¥</button>
            <button class="btn btn-clear" onclick="clearAll()">æ¸…ç©º</button>
        </div>
        <div class="card result-section" id="resultSection">
            <div class="result-title">ğŸ“ ç”Ÿæˆçš„æ—¥æŠ¥</div>
            <div class="result-content" id="reportContent"></div>
            <button class="copy-btn" onclick="copyReport()">å¤åˆ¶æ—¥æŠ¥</button>
        </div>
    </div>
    <script>
        let spotData = null;
        let midtermData = null;
        
        function handleFileSelect(input, type) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                if (type === 'spot') {
                    spotData = jsonData;
                    document.getElementById('spotFileName').textContent = file.name;
                    document.getElementById('spotBox').classList.add('has-file');
                } else {
                    midtermData = jsonData;
                    document.getElementById('midtermFileName').textContent = file.name;
                    document.getElementById('midtermBox').classList.add('has-file');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function identifyUnits(df) {
            const units = [];
            for (let idx = 0; idx < df.length; idx++) {
                const firstCol = String(df[idx][0] || '');
                if (['', 'åˆè®¡', 'èšåˆç»´åº¦'].includes(firstCol)) continue;
                if (/^\d{4}-\d{2}$/.test(firstCol)) continue;
                if (/^\d{4}-\d{2}-\d{2}$/.test(firstCol)) continue;
                if (!isNaN(parseFloat(firstCol)) && firstCol.trim() !== '') continue;
                if (idx >= 3) units.push(firstCol);
            }
            return units;
        }
        
        // æ£€æµ‹æ–‡ä»¶æ ¼å¼ï¼šåŸºäºè¡¨å¤´åˆ¤æ–­
        // æ—§æ ¼å¼(2.17)ï¼šåˆ—1="ç»¼åˆç”µé‡"
        // æ–°æ ¼å¼(å±±è¥¿)ï¼šåˆ—1="ç»¼åˆç”µè´¹"
        function detectFormat(df) {
            const row1 = df[1] || [];
            const col1 = String(row1[1] || '');
            // åŒ…å«"ç”µé‡"è¯´æ˜æ˜¯æ—§æ ¼å¼ï¼ŒåŒ…å«"ç”µè´¹"è¯´æ˜æ˜¯æ–°æ ¼å¼
            if (col1.includes('ç”µé‡')) return 'old';
            if (col1.includes('ç”µè´¹')) return 'new';
            return 'old';
        }
        
        // è§£æç°è´§æ–‡ä»¶
        function parseSpotFile(df, units) {
            const result = {};
            let currentUnit = null;
            const format = detectFormat(df);
            
            for (let idx = 0; idx < df.length; idx++) {
                const firstCol = String(df[idx][0] || '');
                
                // åŒ¹é…åœºç«™å
                for (const unit of units) {
                    if (firstCol === unit) {
                        currentUnit = unit;
                        if (!result[unit]) result[unit] = {};
                        
                        if (format === 'old') {
                            // æ—§æ ¼å¼ï¼šåˆ—1=ç”µé‡, åˆ—3=ç”µä»·
                            result[unit]['æœˆç´¯è®¡ç”µé‡'] = parseFloat(df[idx][1]) || 0;
                            result[unit]['æœˆç´¯è®¡ç”µä»·'] = parseFloat(df[idx][3]) || 0;
                        } else {
                            // æ–°æ ¼å¼ï¼šåˆ—2=ç”µé‡, åˆ—3=ç”µä»·
                            result[unit]['æœˆç´¯è®¡ç”µé‡'] = parseFloat(df[idx][2]) || 0;
                            result[unit]['æœˆç´¯è®¡ç”µä»·'] = parseFloat(df[idx][3]) || 0;
                        }
                        break;
                    }
                }
                
                // åŒ¹é…æ—¥æœŸè¡Œ
                const dateMatch = firstCol.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (dateMatch && currentUnit) {
                    const dateStr = firstCol;
                    if (!result.daily_data) result.daily_data = {};
                    
                    let dailyEnergy, dailyCost, dailyPrice;
                    let midEnergy = 0, midFee = 0;
                    
                    if (format === 'old') {
                        // æ—§æ ¼å¼ï¼šåˆ—1=ç”µé‡, åˆ—2=ç”µè´¹, åˆ—3=ç”µä»·
                        dailyEnergy = parseFloat(df[idx][1]) || 0;
                        dailyCost = parseFloat(df[idx][2]) || 0;
                        dailyPrice = parseFloat(df[idx][3]) || 0;
                        
                        // ä¸­é•¿æœŸ = çœé—´(åˆ—4,5) + çœå†…(åˆ—7,8)
                        const sjEnergy = parseFloat(df[idx][4]) || 0;
                        const sjFee = parseFloat(df[idx][5]) || 0;
                        const snEnergy = parseFloat(df[idx][7]) || 0;
                        const snFee = parseFloat(df[idx][8]) || 0;
                        midEnergy = sjEnergy + snEnergy;
                        midFee = sjFee + snFee;
                    } else {
                        // æ–°æ ¼å¼ï¼šåˆ—1=ç”µè´¹, åˆ—2=ç”µé‡, åˆ—3=ç”µä»·
                        dailyEnergy = parseFloat(df[idx][2]) || 0;
                        dailyCost = parseFloat(df[idx][1]) || 0;
                        dailyPrice = parseFloat(df[idx][3]) || 0;
                        
                        // ä¸­é•¿æœŸï¼šå¸‚åœºåŒ–ä¸­é•¿æœŸ åˆ—5=ç”µé‡, åˆ—6=ç”µè´¹
                        midEnergy = parseFloat(df[idx][5]) || 0;
                        midFee = parseFloat(df[idx][6]) || 0;
                    }
                    
                    const midPrice = midEnergy > 0 ? midFee / midEnergy : 0;
                    
                    if (!result.daily_data[dateStr]) result.daily_data[dateStr] = {};
                    result.daily_data[dateStr][currentUnit] = {
                        'ç»¼åˆç”µé‡': dailyEnergy,
                        'ç»¼åˆç”µè´¹': dailyCost,
                        'ç»¼åˆç”µä»·': dailyPrice,
                        'ä¸­é•¿æœŸç”µé‡': midEnergy,
                        'ä¸­é•¿æœŸç”µè´¹': midFee,
                        'ä¸­é•¿æœŸç”µä»·': midPrice
                    };
                }
            }
            return result;
        }
        
        function parseMidtermFile(df, units) {
            const result = {};
            for (let idx = 0; idx < df.length; idx++) {
                const firstCol = String(df[idx][0] || '');
                for (const unit of units) {
                    if (firstCol === unit) {
                        if (!result[unit]) result[unit] = {};
                        result[unit]['æ—¥æ»šåŠ¨ç”µé‡'] = parseFloat(df[idx][2]) || 0;
                        result[unit]['æ—¥æ»šåŠ¨ç›ˆåˆ©'] = parseFloat(df[idx][1]) || 0;
                    }
                }
            }
            return result;
        }
        
        function getLatestDate(spotData) {
            if (!spotData.daily_data) return null;
            const dates = Object.keys(spotData.daily_data);
            if (dates.length === 0) return null;
            dates.sort().reverse();
            return dates[0];
        }
        
        function getDayOfMonth(dateStr) {
            const match = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (match) return parseInt(match[3]);
            return null;
        }
        
        function formatPrice(price) {
            if (price === Math.floor(price)) return String(Math.floor(price));
            let priceStr = price.toFixed(2);
            if (priceStr.endsWith('0')) priceStr = priceStr.slice(0, -1);
            return priceStr;
        }
        
        function generateReport() {
            if (!spotData && !midtermData) { alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶'); return; }
            
            try {
                const lines = [];
                let units = spotData ? identifyUnits(spotData) : (midtermData ? identifyUnits(midtermData) : []);
                let spotParsed = spotData ? parseSpotFile(spotData, units) : null;
                let midtermParsed = midtermData ? parseMidtermFile(midtermData, units) : null;
                
                const hasSpot = spotData && spotParsed;
                const hasMidterm = midtermData && midtermParsed;
                
                if (hasSpot && !hasMidterm) {
                    const latestDate = getLatestDate(spotParsed);
                    if (!latestDate) { alert('æ— æ³•ä»çœå†…ç°è´§å¤ç›˜æ–‡ä»¶ä¸­æ‰¾åˆ°æ—¥æœŸæ•°æ®'); return; }
                    
                    const dayOfMonth = getDayOfMonth(latestDate);
                    const month = parseInt(latestDate.split('-')[1]);
                    
                    lines.push(`${month}æœˆ${dayOfMonth}æ—¥äº¤æ˜“åŠç»“ç®—æƒ…å†µé¢„ä¼°`);
                    
                    for (let i = 0; i < units.length; i++) {
                        const unit = units[i];
                        const dailyDataAll = (spotParsed.daily_data || {})[latestDate] || {};
                        const dailyData = dailyDataAll[unit] || {};
                        const monthlyData = spotParsed[unit] || {};
                        
                        const income = (dailyData['ç»¼åˆç”µè´¹'] || 0) / 10000;
                        const energy = dailyData['ç»¼åˆç”µé‡'] || 0;
                        const price = dailyData['ç»¼åˆç”µä»·'] || 0;
                        const midEnergy = dailyData['ä¸­é•¿æœŸç”µé‡'] || 0;
                        const midPrice = dailyData['ä¸­é•¿æœŸç”µä»·'] || 0;
                        const cumulativeEnergy = monthlyData['æœˆç´¯è®¡ç”µé‡'] || 0;
                        const cumulativePrice = monthlyData['æœˆç´¯è®¡ç”µä»·'] || 0;
                        
                        let line1 = `${i + 1}. ${unit}ç»¼åˆç»Ÿè®¡æ”¶å…¥${income.toFixed(2)}ä¸‡å…ƒï¼Œç»¼åˆç”µé‡${energy.toFixed(2)}MWhï¼Œç»¼åˆç”µä»·${price.toFixed(2)}å…ƒ/MWh`;
                        if (midEnergy > 0) {
                            const midPriceStr = formatPrice(midPrice);
                            if (i > 0) line1 += `ï¼›å…¶ä¸­ä¸­é•¿æœŸç”µé‡${midEnergy.toFixed(2)}MWhï¼Œä¸­é•¿æœŸç”µä»·${midPriceStr}å…ƒ/MWhã€‚`;
                            else line1 += `ï¼Œå…¶ä¸­ä¸­é•¿æœŸç”µé‡${midEnergy.toFixed(2)}MWhï¼Œä¸­é•¿æœŸç”µä»·${midPriceStr}å…ƒ/MWhã€‚`;
                        } else { line1 += 'ã€‚'; }
                        lines.push(line1);
                        lines.push(`1-${dayOfMonth}æ—¥ç´¯è®¡ç»¼åˆç”µé‡${cumulativeEnergy.toFixed(2)}MWhï¼Œç»¼åˆç”µä»·${cumulativePrice.toFixed(2)}å…ƒ/MWh`);
                    }
                } else if (!hasSpot && hasMidterm) {
                    for (let i = 0; i < units.length; i++) {
                        const unit = units[i];
                        const midtermInfo = midtermParsed[unit] || {};
                        const rollEnergy = midtermInfo['æ—¥æ»šåŠ¨ç”µé‡'] || 0;
                        const rollProfit = midtermInfo['æ—¥æ»šåŠ¨ç›ˆåˆ©'] || 0;
                        if (rollEnergy > 0) lines.push(`å½“æ—¥æ—¥æ»šåŠ¨æˆäº¤ç”µé‡${rollEnergy.toFixed(0)}MWhï¼Œç›ˆåˆ©${rollProfit.toFixed(2)}å…ƒã€‚`);
                        else lines.push('å½“æ—¥æ—¥æ»šåŠ¨äº¤æ˜“æ— æˆäº¤ã€‚');
                    }
                    if (lines.length === 0) { alert('æœªæ‰¾åˆ°ä¸­é•¿æœŸå¤ç›˜æ•°æ®'); return; }
                } else if (hasSpot && hasMidterm) {
                    const latestDate = getLatestDate(spotParsed);
                    if (!latestDate) { alert('æ— æ³•ä»çœå†…ç°è´§å¤ç›˜æ–‡ä»¶ä¸­æ‰¾åˆ°æ—¥æœŸæ•°æ®'); return; }
                    
                    const dayOfMonth = getDayOfMonth(latestDate);
                    const month = parseInt(latestDate.split('-')[1]);
                    
                    lines.push(`${month}æœˆ${dayOfMonth}æ—¥äº¤æ˜“åŠç»“ç®—æƒ…å†µé¢„ä¼°`);
                    
                    for (let i = 0; i < units.length; i++) {
                        const unit = units[i];
                        const dailyDataAll = (spotParsed.daily_data || {})[latestDate] || {};
                        const dailyData = dailyDataAll[unit] || {};
                        const monthlyData = spotParsed[unit] || {};
                        const midtermInfo = midtermParsed[unit] || {};
                        
                        const income = (dailyData['ç»¼åˆç”µè´¹'] || 0) / 10000;
                        const energy = dailyData['ç»¼åˆç”µé‡'] || 0;
                        const price = dailyData['ç»¼åˆç”µä»·'] || 0;
                        const midEnergy = dailyData['ä¸­é•¿æœŸç”µé‡'] || 0;
                        const midPrice = dailyData['ä¸­é•¿æœŸç”µä»·'] || 0;
                        const cumulativeEnergy = monthlyData['æœˆç´¯è®¡ç”µé‡'] || 0;
                        const cumulativePrice = monthlyData['æœˆç´¯è®¡ç”µä»·'] || 0;
                        const rollEnergy = midtermInfo['æ—¥æ»šåŠ¨ç”µé‡'] || 0;
                        const rollProfit = midtermInfo['æ—¥æ»šåŠ¨ç›ˆåˆ©'] || 0;
                        
                        let line1 = `${i + 1}. ${unit}ç»¼åˆç»Ÿè®¡æ”¶å…¥${income.toFixed(2)}ä¸‡å…ƒï¼Œç»¼åˆç”µé‡${energy.toFixed(2)}MWhï¼Œç»¼åˆç”µä»·${price.toFixed(2)}å…ƒ/MWh`;
                        if (midEnergy > 0) {
                            const midPriceStr = formatPrice(midPrice);
                            if (i > 0) line1 += `ï¼›å…¶ä¸­ä¸­é•¿æœŸç”µé‡${midEnergy.toFixed(2)}MWhï¼Œä¸­é•¿æœŸç”µä»·${midPriceStr}å…ƒ/MWhã€‚`;
                            else line1 += `ï¼Œå…¶ä¸­ä¸­é•¿æœŸç”µé‡${midEnergy.toFixed(2)}MWhï¼Œä¸­é•¿æœŸç”µä»·${midPriceStr}å…ƒ/MWhã€‚`;
                        } else { line1 += 'ã€‚'; }
                        lines.push(line1);
                        lines.push(`1-${dayOfMonth}æ—¥ç´¯è®¡ç»¼åˆç”µé‡${cumulativeEnergy.toFixed(2)}MWhï¼Œç»¼åˆç”µä»·${cumulativePrice.toFixed(2)}å…ƒ/MWh`);
                        
                        if (rollEnergy > 0) lines.push(`å½“æ—¥æ—¥æ»šåŠ¨æˆäº¤ç”µé‡${rollEnergy.toFixed(0)}MWhï¼Œç›ˆåˆ©${rollProfit.toFixed(2)}å…ƒã€‚`);
                        else lines.push('å½“æ—¥æ—¥æ»šåŠ¨äº¤æ˜“æ— æˆäº¤ã€‚');
                    }
                }
                
                document.getElementById('reportContent').textContent = lines.join('\n');
                document.getElementById('resultSection').classList.add('show');
            } catch (error) { alert('ç”Ÿæˆå¤±è´¥: ' + error.message); }
        }
        
        function copyReport() {
            const content = document.getElementById('reportContent').textContent;
            navigator.clipboard.writeText(content).then(() => { alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'); }).catch(err => { alert('å¤åˆ¶å¤±è´¥'); });
        }
        
        function clearAll() {
            spotData = null; midtermData = null;
            document.getElementById('spotFile').value = '';
            document.getElementById('midtermFile').value = '';
            document.getElementById('spotFileName').textContent = '';
            document.getElementById('midtermFileName').textContent = '';
            document.getElementById('spotBox').classList.remove('has-file');
            document.getElementById('midtermBox').classList.remove('has-file');
            document.getElementById('resultSection').classList.remove('show');
        }
    </script>
</body>
</html>
